<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Dayflow</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <main class="login-section">
        <div class="login-container">
            <div class="login-box">
                <div class="logo" style="justify-content: center; margin-bottom: 1.5rem;">
                    <img src="../../images/logo.png" alt="Dayflow Logo" style="max-width: 120px; height: auto;">
                </div>
                <h2>Reset Password</h2>
                <p class="login-subtitle">Create a new password for your account</p>
                
                <div class="alert alert-info" id="info-message" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; background-color: #dbeafe; color: #1e40af; font-size: 0.875rem;">
                    <strong>First-time login detected!</strong> Please set a new password to continue.
                </div>

                <form action="" method="post" class="login-form" id="reset-password-form">
                    <div class="form-group">
                        <label for="current-password">Current Password :-</label>
                        <input type="password" name="current-password" id="current-password" placeholder="Enter current password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password">New Password :-</label>
                        <input type="password" name="new-password" id="new-password" placeholder="Enter new password" required minlength="8">
                        <small style="color: var(--gray); font-size: 0.75rem;">Minimum 8 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password :-</label>
                        <input type="password" name="confirm-password" id="confirm-password" placeholder="Confirm new password" required>
                    </div>

                    <div class="password-requirements" style="margin-bottom: 1rem; padding: 0.75rem; background-color: var(--gray-lighter); border-radius: 8px; font-size: 0.875rem;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem; color: var(--dark);">Password must contain:</p>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--gray);">
                            <li id="length-check">At least 8 characters</li>
                            <li id="uppercase-check">One uppercase letter</li>
                            <li id="lowercase-check">One lowercase letter</li>
                            <li id="number-check">One number</li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">Reset Password</button>
                    
                    <div class="login-footer">
                        <p><a href="login.html">Back to Login</a></p>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="../../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resetForm = document.getElementById('reset-password-form');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const currentPasswordInput = document.getElementById('current-password');

            // Password validation checks
            const checks = {
                length: document.getElementById('length-check'),
                uppercase: document.getElementById('uppercase-check'),
                lowercase: document.getElementById('lowercase-check'),
                number: document.getElementById('number-check')
            };

            // Real-time password validation
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                
                // Length check
                if (password.length >= 8) {
                    checks.length.style.color = 'var(--success)';
                    checks.length.innerHTML = '✓ At least 8 characters';
                } else {
                    checks.length.style.color = 'var(--gray)';
                    checks.length.innerHTML = 'At least 8 characters';
                }

                // Uppercase check
                if (/[A-Z]/.test(password)) {
                    checks.uppercase.style.color = 'var(--success)';
                    checks.uppercase.innerHTML = '✓ One uppercase letter';
                } else {
                    checks.uppercase.style.color = 'var(--gray)';
                    checks.uppercase.innerHTML = 'One uppercase letter';
                }

                // Lowercase check
                if (/[a-z]/.test(password)) {
                    checks.lowercase.style.color = 'var(--success)';
                    checks.lowercase.innerHTML = '✓ One lowercase letter';
                } else {
                    checks.lowercase.style.color = 'var(--gray)';
                    checks.lowercase.innerHTML = 'One lowercase letter';
                }

                // Number check
                if (/[0-9]/.test(password)) {
                    checks.number.style.color = 'var(--success)';
                    checks.number.innerHTML = '✓ One number';
                } else {
                    checks.number.style.color = 'var(--gray)';
                    checks.number.innerHTML = 'One number';
                }
            });

            // Form submission
            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const currentPassword = currentPasswordInput.value;
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // Validate passwords match
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match!');
                    return;
                }

                // Validate password strength
                if (newPassword.length < 8 || 
                    !/[A-Z]/.test(newPassword) || 
                    !/[a-z]/.test(newPassword) || 
                    !/[0-9]/.test(newPassword)) {
                    alert('Password does not meet the requirements!');
                    return;
                }

                // Validate new password is different from current
                if (currentPassword === newPassword) {
                    alert('New password must be different from current password!');
                    return;
                }

                try {
                    // Get user data from localStorage
                    const userData = JSON.parse(localStorage.getItem('user'));
                    if (!userData || !userData.token) {
                        alert('Session expired. Please login again.');
                        window.location.href = 'login.html';
                        return;
                    }

                    // Call reset password API
                    const response = await fetch('http://localhost:8000/api/auth/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userData.token}`
                        },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('Password reset successfully! Please login with your new password.');
                        
                        // Clear localStorage and redirect to login
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                    } else {
                        alert(data.detail || 'Failed to reset password. Please try again.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                }
            });
        });
    </script>
</body>
</html>
